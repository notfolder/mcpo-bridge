# OpenWebUI設定ガイド - MCPO Bridgeとの連携

## 概要

本ドキュメントでは、OpenWebUIからMCPO Bridgeを通じてファイル生成系MCPサーバー（PowerPoint、Excel等）を利用する際の設定方法を説明します。

## 前提知識

### MCPO Bridgeのファイル生成フロー

1. **リクエスト送信**: OpenWebUI → Nginx → MCPO Bridge
2. **プロセス起動**: Bridge が MCP サーバープロセスを起動
3. **ファイル生成**: MCPサーバーが `./data/mcpo-jobs/{job-uuid}/` にファイル生成
4. **URL返却**: MCPサーバーがダウンロードURL (`http://nginx/files/{job-uuid}/{filename}`) を返却
5. **ダウンロード**: ユーザーブラウザが Nginx 経由でファイルをダウンロード

### ステートフル vs ステートレスモード

| モード | 説明 | 適用例 | 動作 |
|--------|------|--------|------|
| **Stateless** | リクエスト毎にプロセス起動・終了 | Excel、単発生成ツール | 1リクエスト = 1プロセス、即座に終了 |
| **Stateful** | チャットごとにプロセス維持 | PowerPoint（複数スライド追加等） | セッション維持、アイドルタイムアウト後終了 |

設定は `config/mcp-servers.json` の `mode` パラメータで制御します。

## OpenWebUIの設定

### 1. 管理画面からMCPツールを登録

#### 手順

1. OpenWebUI管理画面にアクセス
2. **Settings** → **Admin Settings** → **Tools** に移動
3. **Add Tool** をクリック
4. **Connection Type** を選択:
   - **OpenAPI**: MCPO経由でMCPサーバーを利用（推奨）
   - **MCP (Streamable HTTP)**: 直接MCP接続

#### OpenAPI（MCPO経由）設定例

```
Name: PowerPoint Generator
Type: OpenAPI
API Endpoint: http://nginx:8080/mcpo/powerpoint
API Key: (設定していない場合は空欄)
```

```
Name: Excel Generator
Type: OpenAPI
API Endpoint: http://nginx:8080/mcpo/excel
API Key: (設定していない場合は空欄)
```

**注意**: 
- `nginx` はDocker Compose内のサービス名です
- ポート番号は docker-compose.yml の設定に合わせてください
- エンドポイントパスは `/mcpo/{server_type}` 形式です

### 2. システムプロンプト設定

OpenWebUIのシステムプロンプトで、AIモデルに対してファイル生成ツールの使用方法を指示します。

#### ステートレスモード用システムプロンプト

```markdown
# システム指示

あなたはファイル生成アシスタントです。以下のツールを利用できます：

## Excel Generator (Stateless)

- **用途**: Excelファイルの一発生成
- **動作**: リクエストごとに新しいプロセスで処理
- **使用方法**: 
  1. ユーザーの要求を理解する
  2. Excel Generator ツールを呼び出す
  3. 返却されたダウンロードURLをユーザーに提示する

### 重要事項

- **1リクエスト完結**: 1回のツール呼び出しで完全なファイルを生成してください
- **状態は保持されない**: 前回の呼び出し内容は引き継がれません
- **URL提示**: ツールが返したURLをそのままユーザーに提示してください

### 例

ユーザー: 「売上データのExcelファイルを作成して」

1. Excel Generator を呼び出す（全データを1回で渡す）
2. 返却されたURL（例: `http://localhost/files/abc-123/sales.xlsx`）をユーザーに提示
3. ユーザーがリンクをクリックしてダウンロード
```

#### ステートフルモード用システムプロンプト

```markdown
# システム指示

あなたはファイル生成アシスタントです。以下のツールを利用できます：

## PowerPoint Generator (Stateful)

- **用途**: PowerPointプレゼンテーションの作成・編集
- **動作**: セッション維持型（同一ユーザーからの複数リクエストで状態保持）
- **使用方法**:
  1. プレゼンテーション作成を開始
  2. スライド追加・編集を繰り返し実行可能
  3. 完成したらダウンロードURLを提示

### 重要事項

- **セッション維持**: 30分間（デフォルト）は同一プロセスで処理されます
- **段階的編集可能**: 「スライドを追加」「タイトルを変更」など段階的な指示が可能
- **完成時にURL提示**: 最終的なファイルのURLを提示してください
- **セッション終了**: 30分間操作がないと自動的にセッションが終了します

### 例

ユーザー: 「会社紹介のプレゼンを作って」

1. PowerPoint Generator でプレゼンテーション作成を開始
2. ユーザー: 「もう1スライド追加して」→ 同じプロセスで追加
3. ユーザー: 「タイトルを変更して」→ 同じプロセスで変更
4. 完成後、ダウンロードURL（例: `http://localhost/files/def-456/presentation.pptx`）を提示

**注意**: 
- 30分以上操作がない場合、新しいプレゼンテーションとして開始されます
- セッションが切れた場合は、新規作成から再開してください
```

#### ステートフル＋ステートレス混在環境用システムプロンプト

```markdown
# システム指示

あなたは多機能ファイル生成アシスタントです。以下のツールを利用できます：

## 1. PowerPoint Generator (Stateful - セッション維持型)

- **特徴**: 複数回の編集リクエストに対応、30分間状態維持
- **使用シーン**: 段階的なプレゼンテーション作成、複数回の修正
- **使用方法**:
  1. プレゼンテーション作成開始
  2. 繰り返しスライド追加・編集が可能
  3. 完成したらURLを提示

## 2. Excel Generator (Stateless - 単発実行型)

- **特徴**: 1リクエストで完結、状態は保持されない
- **使用シーン**: データのエクスポート、レポート生成
- **使用方法**:
  1. 1回のツール呼び出しで全データを渡す
  2. 生成されたURLを即座に提示

## 使い分けの判断基準

### PowerPoint Generator を使う場合:
- 「プレゼンを作って、その後スライドを追加したい」
- 「途中で内容を変更するかもしれない」
- 複数段階の編集が予想される

### Excel Generator を使う場合:
- 「このデータをExcelにして」
- 「レポートを生成して」
- 一度の実行で完結する

## 重要事項

1. **URL提示**: 生成されたファイルのURLは必ずユーザーに提示してください
2. **セッション意識**: PowerPointは30分間状態維持、Excelは毎回新規
3. **完全性**: Excelは1回で完全なファイルを生成してください
4. **段階的編集**: PowerPointは段階的な編集指示に対応できます
```

### 3. チャット画面でのツール有効化

ユーザーがチャットを開始する際に、使用するツールを明示的に有効化する必要があります。

#### 手順

1. チャット画面左下の **Tools** アイコンをクリック
2. 使用したいツール（PowerPoint Generator、Excel Generator等）を選択
3. チェックマークが付いていることを確認

#### ユーザーへの説明例

```
## ファイル生成ツールの使い方

1. チャット画面左下の「ツール」アイコンをクリック
2. 「PowerPoint Generator」または「Excel Generator」を選択
3. チャット欄で「プレゼンを作って」「Excelファイルを作成して」等と指示
4. 生成されたダウンロードリンクをクリックしてファイルを取得
```

## モード別の推奨設定

### Stateless（ステートレス）モードの場合

#### 設定ファイル (config/mcp-servers.json)

```json
{
  "mcpServers": {
    "excel": {
      "command": "uvx",
      "args": ["excel-mcp-server", "stdio"],
      "mode": "stateless"
    }
  }
}
```

#### システムプロンプトでの注意点

- **1回で完結**: 全ての情報を1回のリクエストで渡すよう指示
- **状態非保持**: 前回の実行内容は引き継がれないことを明記
- **即座にURL提示**: ツール実行後、すぐにダウンロードURLを表示

#### ユーザー体験

- シンプルで高速
- リソース効率が良い
- 複雑な編集には不向き

### Stateful（ステートフル）モードの場合

#### 設定ファイル (config/mcp-servers.json)

```json
{
  "mcpServers": {
    "powerpoint": {
      "command": "npx",
      "args": ["-y", "@gongrzhe/office-powerpoint-mcp-server"],
      "env": {
        "NODE_ENV": "production"
      },
      "mode": "stateful",
      "idle_timeout": 1800,
      "max_processes_per_chat": 1
    }
  }
}
```

#### システムプロンプトでの注意点

- **セッション維持時間**: 30分（1800秒）を明記
- **段階的編集可能**: 複数回のリクエストで編集できることを説明
- **セッション終了条件**: アイドルタイムアウトについて言及
- **最終URL提示**: 編集完了後にURLを表示

#### ユーザー体験

- 柔軟な編集が可能
- 対話的なファイル作成
- セッションタイムアウトに注意が必要

## トラブルシューティング

### ツールが表示されない

**原因**: OpenWebUI管理画面でツールが登録されていない

**解決策**:
1. Admin Settings → Tools を確認
2. ツールが登録されているか確認
3. API Endpoint が正しいか確認（`http://nginx:8080/mcpo/{server_type}`）

### ファイルがダウンロードできない

**原因1**: URLが間違っている

**解決策**: 
- MCPサーバーが返すURLは `http://nginx/files/{job-uuid}/{filename}` 形式
- Nginxが適切に設定されているか確認

**原因2**: ファイルが生成されていない

**解決策**:
```bash
# ジョブディレクトリを確認
ls -la ./data/mcpo-jobs/

# Bridgeログを確認
docker-compose logs mcpo-bridge
```

### ステートフルモードでセッションが維持されない

**原因1**: Nginxの`ip_hash`が設定されていない

**解決策**: nginx設定を確認
```nginx
upstream mcpo-bridge {
    ip_hash;  # これが必要
    server mcpo-bridge:8080;
}
```

**原因2**: アイドルタイムアウトが短い

**解決策**: `config/mcp-servers.json` の `idle_timeout` を延長
```json
{
  "idle_timeout": 3600  // 1時間に延長
}
```

### AIがツールを使わない

**原因**: システムプロンプトが不十分

**解決策**:
- システムプロンプトでツールの使用方法を明確に指示
- 「必ず〜ツールを使用してください」等の強い指示を追加
- 例を具体的に記載

## ベストプラクティス

### 1. モードの適切な選択

- **単発生成**: Stateless
- **段階的編集**: Stateful

### 2. タイムアウト設定

- 短いタスク（<5分）: Stateless推奨
- 対話的編集（5-30分）: Stateful with 1800s timeout
- 長時間作業（>30分）: idle_timeout延長を検討

### 3. セキュリティ

- 本番環境では適切な認証設定を追加
- プライベートネットワーク内での使用を推奨（特にStatefulモード）
- API Keyの設定を検討

### 4. ユーザーガイダンス

- システムプロンプトで使い方を明確に説明
- URL提示の形式を統一
- エラー時の対処法を記載

## まとめ

### Statelessモード
- ✅ シンプル、高速、リソース効率良
- ❌ 段階的編集不可

### Statefulモード  
- ✅ 段階的編集可能、対話的作業
- ❌ リソース常駐、タイムアウト管理必要

適切なモード選択とシステムプロンプト設定により、OpenWebUIでのファイル生成体験を最適化できます。
